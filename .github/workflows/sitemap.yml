name: Build & Commit Sitemap (docs)

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "30 2 * * *"   # 每天 02:30 UTC（北京 10:30）
  workflow_dispatch: {}

permissions:
  contents: write   # 关键：允许写入

jobs:
  build-sitemap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug: show repo tree
        run: |
          echo "== PWD ==" && pwd
          echo "== ROOT ==" && ls -la
          echo "== DOCS ==" && ls -la docs || echo "(no docs dir)"

      - name: Generate docs/sitemap.xml (inline Python)
        shell: bash
        run: |
          python3 - <<'PY'
          import os, subprocess, datetime, xml.sax.saxutils

          BASE_URL   = "https://opmhoubue-eng.github.io/yuanmago-posts"
          POSTS_DIR  = "docs"
          OUTPUT_XML = "docs/sitemap.xml"

          os.makedirs(POSTS_DIR, exist_ok=True)  # 没有 docs 也创建，避免直接失败

          def git_last_commit_iso(path: str):
              try:
                  ts = subprocess.check_output(
                      ["git", "log", "-1", "--pretty=format:%cI", "--", path],
                      stderr=subprocess.DEVNULL,
                      text=True
                  ).strip()
                  return ts or None
              except Exception:
                  return None

          def file_mtime_iso(path: str):
              ts = datetime.datetime.utcfromtimestamp(os.path.getmtime(path))
              return ts.replace(microsecond=0).isoformat() + "Z"

          urls = []
          for root, _, files in os.walk(POSTS_DIR):
              for name in files:
                  if not name.lower().endswith(".html"):
                      continue
                  full = os.path.join(root, name)
                  rel  = os.path.relpath(full, POSTS_DIR).replace(os.sep, "/")
                  url  = f"{BASE_URL}/{rel}"
                  last = git_last_commit_iso(full) or file_mtime_iso(full)
                  urls.append((url, last))

          urls.sort(key=lambda x: x[0])

          # 即使没有任何 HTML，也生成一个空壳 sitemap，避免报错
          with open(OUTPUT_XML, "w", encoding="utf-8") as f:
              f.write('<?xml version="1.0" encoding="UTF-8"?>\n')
              f.write('<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n')
              for loc, lastmod in urls:
                  f.write("  <url>\n")
                  f.write(f"    <loc>{xml.sax.saxutils.escape(loc)}</loc>\n")
                  f.write(f"    <lastmod>{lastmod}</lastmod>\n")
                  f.write("  </url>\n")
              f.write("</urlset>\n")

          print(f"OK: generated {OUTPUT_XML} with {len(urls)} urls.")
          PY

          echo "== SITEMAP HEAD =="
          head -n 30 docs/sitemap.xml || true

      - name: Commit & push if changed
        shell: bash
        run: |
          set -e
          if ! git diff --quiet -- docs/sitemap.xml; then
            git config user.name  "actions-bot"
            git config user.email "actions@github.com"
            git add docs/sitemap.xml
            git commit -m "chore: update docs/sitemap.xml [skip ci]"
            # 防非快进：先拉后推
            git pull --rebase origin main || true
            git push origin HEAD:main
            echo "✅ pushed sitemap.xml"
          else
            echo "ℹ️ no changes in sitemap.xml"
          fi
